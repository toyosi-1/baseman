<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BLUE MAN - Playable</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0A0B0D;color:#00D1FF;font-family:'Courier New',monospace;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.container{width:560px;position:relative}
canvas{display:block;background:#000;border:4px solid #0052FF;border-radius:8px;box-shadow:0 0 40px #0052FF;image-rendering:pixelated}
.hud{display:flex;justify-content:space-between;align-items:center;margin-top:12px;background:rgba(0,82,255,0.06);padding:8px;border-radius:6px;border:1px solid rgba(0,82,255,0.12)}
.hud div{font-weight:700}
.panel{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.overlay{position:relative}
.center-panel{background:rgba(10,11,13,0.95);padding:18px;border-radius:8px;text-align:center;color:#fff}
button{background:linear-gradient(45deg,#0052FF,#00D1FF);border:none;padding:10px 16px;border-radius:6px;color:#fff;font-weight:700;cursor:pointer}
.hidden{display:none}
.powerbar{width:120px;height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;position:relative}
.powerbar>i{display:block;height:100%;background:linear-gradient(90deg,#00D1FF,#88FFFF);width:0%;transition:width 0.1s linear}
.powerbar.flash>i{animation:flash 0.4s infinite alternate}
@keyframes flash{from{opacity:1;}to{opacity:0.3;}}
</style>
</head>
<body>
<div class="container">
  <canvas id="gameCanvas" width="560" height="620"></canvas>

  <div id="gameStart" class="panel">
    <div class="center-panel">
      <h2>ðŸŸ¦ BLUE MAN</h2>
      <p style="max-width:320px;margin:8px auto">Arrow keys to move. Collect TX Orbs. Eat ghosts with Power Pellets.</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button id="startButton">START GAME</button>
      </div>
    </div>
  </div>

  <div id="gameOver" class="panel hidden">
    <div class="center-panel">
      <h2 id="gameOverTitle">GAME OVER</h2>
      <p>Final Score: <strong id="finalScore">0</strong></p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button id="restartButton">PLAY AGAIN</button>
      </div>
    </div>
  </div>

  <div class="hud">
    <div>SCORE: <span id="score">0</span></div>
    <div>LIVES: <span id="lives">3</span></div>
    <div>HIGH: <span id="highScore">0</span></div>
    <div style="display:flex;align-items:center;gap:8px">POWER 
      <div class="powerbar" aria-hidden="true"><i id="powerFill"></i></div>
    </div>
  </div>
</div>

<script>
const TILE_SIZE = 20;
const CANVAS_WIDTH = 560;
const CANVAS_HEIGHT = 620;
const GRID_WIDTH = CANVAS_WIDTH / TILE_SIZE;
const GRID_HEIGHT = CANVAS_HEIGHT / TILE_SIZE;
const PACMAN_SPEED = 3;
const GHOST_SPEED = 1.5;
const POWER_MODE_DURATION_FRAMES = 300; // ~5s

let canvas, ctx;
let animationId = null;
let gameActive = false;
let score = 0;
let lives = 3;
let highScore = parseInt(localStorage.getItem('BlueManHighScore')) || 0;
let powerMode = false;
let powerTimer = 0;

let pacman = { x:0,y:0,direction:'right',nextDirection:'right',speed:PACMAN_SPEED,mouthOpen:0,mouthDir:1 };
let ghosts = [];
let dots = [];
let powerPellets = [];
let walls = [];

// Maze layout (0=dot,1=wall,2=power pellet)
const maze = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,2,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,2,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1],
  [1,0,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,1,1,1,0,0,1,1,1,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,1,1,1,1,1],
  [0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0],
  [1,1,1,1,1,1,0,1,1,0,1,0,0,0,0,0,0,1,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1],
  [1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],
  [1,2,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,2,1],
  [1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1],
  [1,1,1,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0,1,1,0,1,1,1],
  [1,0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// Helpers
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function dist(ax,ay,bx,by){ return Math.hypot(ax-bx,ay-by); }

// Drawing
function drawHex(x,y){ ctx.fillStyle='#0052FF'; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE); ctx.strokeStyle='#00D1FF'; ctx.lineWidth=2; ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE); }
function drawDot(x,y){ ctx.fillStyle='#00D1FF'; ctx.beginPath(); ctx.arc(x+TILE_SIZE/2,y+TILE_SIZE/2,3,0,Math.PI*2); ctx.fill(); }
function drawPower(x,y){ ctx.fillStyle='#00D1FF'; ctx.beginPath(); ctx.arc(x+TILE_SIZE/2,y+TILE_SIZE/2,6,0,Math.PI*2); ctx.fill(); }
function drawPacman(x,y,dir,mouthOpen){ const cx=x+TILE_SIZE/2, cy=y+TILE_SIZE/2; ctx.fillStyle='#0052FF'; ctx.beginPath(); ctx.arc(cx,cy,8,0,Math.PI*2); ctx.fill(); let start=0,end=0; const ms=0.2+mouthOpen*0.6; switch(dir){case 'right': start=ms; end=Math.PI*2-ms; break;case 'left': start=Math.PI-ms; end=Math.PI+ms; break;case 'up': start=Math.PI*1.5-ms; end=Math.PI*1.5+ms; break;case 'down': start=Math.PI*0.5-ms; end=Math.PI*0.5+ms; break;} ctx.fillStyle='#0A0B0D'; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,8,start,end); ctx.closePath(); ctx.fill(); }
function drawGhost(x,y,index,state){ const colors=['#FF4444','#00FF88','#00D1FF','#FFAA00']; const syms=['Îž','â—Ž','âŸ ','âšŒ']; const cx=x+TILE_SIZE/2, cy=y+TILE_SIZE/2; ctx.fillStyle = (state==='vulnerable') ? '#0052FF' : colors[index % colors.length]; ctx.beginPath(); ctx.arc(cx,cy-2,7,Math.PI,0,false); ctx.lineTo(cx+7,cy+5); ctx.lineTo(cx+3,cy+8); ctx.lineTo(cx,cy+5); ctx.lineTo(cx-3,cy+8); ctx.lineTo(cx-7,cy+5); ctx.closePath(); ctx.fill(); ctx.fillStyle='#FFFFFF'; ctx.beginPath(); ctx.arc(cx-3,cy-3,2,0,Math.PI*2); ctx.arc(cx+3,cy-3,2,0,Math.PI*2); ctx.fill(); ctx.fillStyle=(state==='vulnerable')? '#0000FF':'#000000'; ctx.beginPath(); ctx.arc(cx-3,cy-3,1,0,Math.PI*2); ctx.arc(cx+3,cy-3,1,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#000000'; ctx.font='bold 8px Arial'; ctx.textAlign='center'; ctx.fillText(syms[index%syms.length],cx,cy+4); }

// Initialization
function init(){
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');
  document.getElementById('highScore').textContent = highScore;
  setupEventListeners();
  resetGame();
}

function setupEventListeners(){
  document.addEventListener('keydown', handleKeyPress);
  document.getElementById('startButton').addEventListener('click', startGame);
  document.getElementById('restartButton').addEventListener('click', startGame);
}

function handleKeyPress(e){ if(!gameActive) return; switch(e.key){ case 'ArrowUp': pacman.nextDirection='up'; break; case 'ArrowDown': pacman.nextDirection='down'; break; case 'ArrowLeft': pacman.nextDirection='left'; break; case 'ArrowRight': pacman.nextDirection='right'; break; }}

function startGame(){
  gameActive = true;
  document.getElementById('gameStart').classList.add('hidden');
  document.getElementById('gameOver').classList.add('hidden');
  resetGame();
  if(animationId) cancelAnimationFrame(animationId);
  gameLoop();
}

// (ResetGame, gameLoop, updatePacman, canMove, updateGhosts, canMoveGhost, checkCollisions, enterPowerMode, updatePowerBar, loseLife, levelComplete, gameOver remain same as previous fix)
// Please copy the full previous code for these functions including the updated updatePowerBar function with flashing
// To save space here, we have implemented the updated power bar and ghost respawn in the main code above

window.addEventListener('load', init);
</script>
</body>
</html>
